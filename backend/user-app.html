<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mezzoi User App</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #1a1a1a; color: white; }
        .container { background: #2d2d2d; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .notification { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; }
        .sos { background: #4a1a1a; border-color: #ff4444; }
        .silent { background: #4a4a1a; border-color: #ffaa44; }
        .custom { background: #1a1a4a; border-color: #4444ff; }
        .location { background: #1a4a1a; border-color: #44ff44; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .connected { background: #155724; color: #d4edda; }
        .disconnected { background: #721c24; color: #f8d7da; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .timestamp { font-size: 0.8em; color: #aaa; }
        .clear-btn { background: #6c757d; }
    </style>
</head>
<body>
    <h1>üì± Mezzoi User App</h1>
    
    <div class="container">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status disconnected">Disconnected</div>
        <button onclick="connectWebSocket()">Connect</button>
        <button onclick="disconnectWebSocket()">Disconnect</button>
        <button onclick="fetchActiveEvents()">Fetch Latest Events</button>
        <button class="clear-btn" onclick="clearNotifications()">Clear All</button>
    </div>

    <div class="container">
        <h2>Live Notifications</h2>
        <div id="notifications">
            <p style="color: #aaa;">Waiting for notifications...</p>
        </div>
    </div>

    <script>
        let ws = null;
        const API_BASE = 'http://localhost:3001';
        const WS_URL = 'ws://localhost:3002';

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                showStatus('Already connected', 'connected');
                return;
            }

            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                showStatus('Connected to Mezzoi Backend', 'connected');
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                displayNotification(data);
            };

            ws.onclose = () => {
                showStatus('Disconnected from Backend', 'disconnected');
                console.log('WebSocket disconnected');
            };

            ws.onerror = (error) => {
                showStatus('Connection Error', 'disconnected');
                console.error('WebSocket error:', error);
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function displayNotification(data) {
            const notificationsDiv = document.getElementById('notifications');
            
            // Clear the waiting message
            if (notificationsDiv.innerHTML.includes('Waiting for notifications')) {
                notificationsDiv.innerHTML = '';
            }

            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification ${getNotificationClass(data.type)}`;
            
            let content = `
                <strong>${getNotificationTitle(data.type)}</strong><br>
                ${data.message}<br>
            `;
            
            if (data.location) {
                content += `üìç Location: ${data.location.lat}, ${data.location.long}<br>`;
            }
            
            content += `<div class="timestamp">‚è∞ ${new Date(data.timestamp).toLocaleString()}</div>`;
            
            notificationDiv.innerHTML = content;
            
            // Add to top of notifications
            notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);
            
            // Play notification sound (if browser allows)
            if (data.type !== 'SILENT_SOS_TRIGGERED') {
                playNotificationSound();
            }
        }

        function getNotificationClass(type) {
            switch (type) {
                case 'SOS_TRIGGERED': return 'sos';
                case 'SILENT_SOS_TRIGGERED': return 'silent';
                case 'CUSTOM_NOTIFICATION': return 'custom';
                case 'LOCATION_UPDATED': return 'location';
                default: return 'custom';
            }
        }

        function getNotificationTitle(type) {
            switch (type) {
                case 'SOS_TRIGGERED': return 'üÜò EMERGENCY SOS ALERT';
                case 'SILENT_SOS_TRIGGERED': return 'üîá SILENT SOS ALERT';
                case 'CUSTOM_NOTIFICATION': return 'üì¢ NOTIFICATION';
                case 'LOCATION_UPDATED': return 'üìç LOCATION UPDATE';
                default: return 'üì± ALERT';
            }
        }

        function playNotificationSound() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        async function fetchActiveEvents() {
            try {
                const response = await fetch(`${API_BASE}/user/active-events`);
                const data = await response.json();
                
                if (response.ok) {
                    const notificationsDiv = document.getElementById('notifications');
                    notificationsDiv.innerHTML = '<h3>Recent Events:</h3>';
                    
                    data.events.forEach(event => {
                        displayNotification(event);
                    });
                } else {
                    console.error('Failed to fetch events');
                }
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        function clearNotifications() {
            document.getElementById('notifications').innerHTML = '<p style="color: #aaa;">Waiting for notifications...</p>';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Auto-connect on page load
        window.onload = () => {
            connectWebSocket();
        };

        // Cleanup on page unload
        window.onbeforeunload = () => {
            disconnectWebSocket();
        };
    </script>
</body>
</html>